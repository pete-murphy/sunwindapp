import React, { Component } from "react"
import { BrowserRouter as Router, Route, NavLink } from "react-router-dom"
import styled from "styled-components"

import ClientForm from "./components/ClientForm"
import SystemForm from "./components/SystemForm"
import TestComponent from "./components/TestComponent"

import {
  generateLifetimeAnnualData,
  getPaybackPeriod
} from "./functions/calculations"
import { fetchPVWatts } from "./functions/fetchPVWatts"
import { sum } from "./functions/library"

const Container = styled.div`
  display: grid;
  grid-template-columns: 4fr 1fr;
  width: 100vw;
  height: 100vh;
  & > * {
    padding: 1rem;
    overflow: scroll;
  }
`
const Main = styled.div``

const Sidebar = styled.div`
  background-color: var(--night);
`

const UL = styled.ul`
  list-style: none;
  margin: 0;
  padding: 0;
`

export const StyledNavLink = styled(NavLink)`
  text-decoration: none;
  color: var(--peach);
  transition: 0.2s all;
  &.active {
    color: var(--haus);
  }
`

const defaultTitle = "SunWind App"

class App extends Component {
  constructor() {
    super()

    this.handleClientChange = this.handleClientChange.bind(this)
    this.handleClientToggle = this.handleClientToggle.bind(this)
    this.state = {
      client: {
        name: {
          last: "",
          first: ""
        },
        address: {
          line1: "",
          line2: "",
          town: "",
          zip: ""
        },
        financialInfo: {
          sRECMarketSector: 1,
          isCommercial: true,
          taxRate: 0.35
        },
        usageData: Array(12).fill(0),
        incentivePrograms: {
          fITC: true,
          sMART: false,
          sREC: true,
          mACRS: true,
          nantucketSolar: false,
          netMetering: true
        }
      },
      system: {
        arrays: [
          {
            moduleAmount: 120,
            moduleCapacity: 310,
            tilt: 45,
            azimuth: 156,
            arrayType: 1,
            costPerWatt: 0,
            losses: 14,
            // Output will be generated by PVWatts fetch
            output: []
          }
        ],
        hasError: true,
        hasSubmitted: false,
        totalSystemCost: 0
      }
    }
  }

  handleClientChange(value, name, category) {
    const client = { ...this.state.client }
    client[category][name] = value
    this.setState(({ client }) => client)
  }

  handleClientToggle(name, category) {
    const client = { ...this.state.client }
    client[category][name] = !client[category][name]
    this.setState(({ client }) => client)
  }

  handleSubmit() {
    // const { arrays, defaultSettings } = this.state.system
    // const promises = arrays.map((array, index) => {
    //   const { moduleAmount, moduleCapacity, tilt, azimuth, arrayType } = array
    //   const systemCapacity = moduleAmount * moduleCapacity / 1000
    //   return fetchPVWatts(systemCapacity, tilt, azimuth, arrayType)
    // })

    // Promise.all(promises).then(outputs => {
    //   const systemOutputs = outputs.map(acMonthly => {
    //     const acAnnual = acMonthly.reduce((a, b) => a + b)
    //     return { acAnnual, acMonthly }
    //   })
    //   this.setState(({system}) => ({
    //     system: {
    //       ...system,
    //       system: {
    //         arrays: systemOutputs
    //       }
    //     }
    //   }))
    // })

    // this.setState({
    //   inputs: { ...this.state.inputs, hasSubmitted: true }
    // })

    const { arrays, defaultSettings } = this.state.system
    arrays.forEach((array, index) => {
      const {
        moduleAmount,
        moduleCapacity,
        tilt,
        azimuth,
        arrayType,
        losses
      } = array
      const systemCapacity = moduleAmount * moduleCapacity / 1000
      fetchPVWatts(systemCapacity, tilt, azimuth, arrayType, losses).then(
        acMonthly => {
          const arrays = { ...this.system.arrays }
          arrays[index] = acMonthly
          this.setState(({ system }) => ({
            system: {
              ...system,
              arrays
            }
          }))
        }
      )
    })
  }

  componentDidMount() {
    document.title = defaultTitle
  }

  componentDidUpdate() {
    const lastName = this.state.client.name.last
    const address = this.state.client.address.line1
    lastName !== ""
      ? (document.title = lastName + (address !== "" ? `, ${address}` : ""))
      : (document.title = defaultTitle)
  }

  render() {
    return (
      <Router>
        <Container>
          <Main>
            <Route
              path="/client"
              exact
              render={() => (
                <ClientForm
                  {...this.state.client}
                  handleChange={this.handleClientChange}
                  handleToggle={this.handleClientToggle}
                />
              )}
            />
            <Route
              path="/system"
              exact
              render={() => (
                <SystemForm
                  {...this.state.client}
                  handleChange={this.handleClientChange}
                  handleToggle={this.handleClientToggle}
                />
              )}
            />
            <Route path="/test" exact render={() => <TestComponent />} />
          </Main>
          <Sidebar>
            <h2>Sidebar</h2>
            <UL>
              <li>
                <StyledNavLink to="/client">Client information</StyledNavLink>
              </li>
              <li>
                <StyledNavLink to="/system">System parameters</StyledNavLink>
              </li>
              <li>
                <StyledNavLink to="/test">Test things</StyledNavLink>
              </li>
            </UL>
          </Sidebar>
        </Container>
      </Router>
    )
  }
}

export default App
