import React, { Component } from "react"
import { BrowserRouter as Router, Route, NavLink } from "react-router-dom"
import styled from "styled-components"

import ClientInfo from "./components/forms/ClientInfo"
import ProjectInfo from "./components/forms/ProjectInfo"

import TestComponent from "./components/TestComponent"

import { fetchPVWatts } from "./functions/fetchPVWatts"

const Container = styled.div`
  display: grid;
  grid-template-columns: 4fr 1fr;
  width: 100vw;
  height: 100vh;
  & > * {
    padding: 1rem;
    overflow: scroll;
  }
`
const Main = styled.div``

const Sidebar = styled.div`
  background-color: var(--night);
`

const UL = styled.ul`
  list-style: none;
  margin: 0;
  padding: 0;
`

export const StyledNavLink = styled(NavLink)`
  text-decoration: none;
  color: var(--peach);
  transition: 0.2s all;
  &.active {
    color: var(--haus);
  }
`

const defaultTitle = "SunWind App"

class App extends Component {
  constructor() {
    super()

    this.handleChange = this.handleChange.bind(this)
    this.state = {
      clientInfo: {
        name: {
          last: "Bojangles",
          first: ""
        },
        address: {
          line1: "",
          line2: "",
          town: "",
          zip: ""
        }
      },
      projectInfo: {
        isCommercial: false,
        incentivePrograms: {
          fITC: true,
          sMART: false,
          sREC: true,
          mACRS: true,
          nantucketSolar: false,
          netMetering: true
        },
        sRECMarketSector: 1,
        mACRSTaxRate: 0.35
      },
      usageData: Array(12).fill(0),
      system: {
        arrays: [
          {
            moduleAmount: 120,
            moduleCapacity: 310,
            tilt: 45,
            azimuth: 156,
            arrayType: 1,
            costPerWatt: 0,
            losses: 14,
            // Output will be generated by PVWatts fetch
            output: []
          }
        ],
        defaultSettings: {
          moduleType: 1,
          // This is data from Boston TMY2
          lat: 41.68,
          lon: -69.96
        }
      },
      arbitraryOutput: 0,
      systemCost: 0,
      hasError: true,
      hasSubmitted: false
    }
  }

  handleChange(n) {
    console.log(JSON.stringify(n))
    console.log(
      JSON.stringify(Object.assign({}, { ...this.state }, n), null, 2)
    )

    this.setState(() => Object.assign({}, { ...this.state }, n))
    // const state = {this.state}
    // this.setState()
    // const state = { ...this.state }
    // state[n] = { ...n }
    // console.log(JSON.stringify(state, null, 2))
    // this.setState(() => ({ n }))
  }

  handleSubmit() {
    const { arrays, defaultSettings } = this.state.system
    arrays.forEach((array, index) => {
      const {
        moduleAmount,
        moduleCapacity,
        tilt,
        azimuth,
        arrayType,
        losses
      } = array
      const systemCapacity = moduleAmount * moduleCapacity / 1000
      fetchPVWatts(systemCapacity, tilt, azimuth, arrayType, losses).then(
        acMonthly => {
          const arrays = { ...this.system.arrays }
          arrays[index] = acMonthly
          this.setState(({ system }) => ({
            system: {
              ...system,
              arrays
            }
          }))
        }
      )
    })
  }

  componentDidMount() {
    document.title = defaultTitle
  }

  componentDidUpdate() {
    const lastName = this.state.clientInfo.name.last
    const address = this.state.clientInfo.address.line1
    lastName !== ""
      ? (document.title = lastName + (address !== "" ? `, ${address}` : ""))
      : (document.title = defaultTitle)
  }

  render() {
    return (
      <Router>
        <Container>
          <Main>
            <Route
              path="/client"
              exact
              render={() => (
                <ClientInfo
                  clientInfo={this.state.clientInfo}
                  handleChange={this.handleChange}
                />
              )}
            />
            <Route
              path="/project"
              exact
              render={() => (
                <ProjectInfo
                  projectInfo={this.state.projectInfo}
                  handleChange={this.handleChange}
                />
              )}
            />
            <Route path="/test" exact render={() => <TestComponent />} />
          </Main>
          <Sidebar>
            <h2>Sidebar</h2>
            <UL>
              <li>
                <StyledNavLink to="/client">Client information</StyledNavLink>
              </li>
              <li>
                <StyledNavLink to="/project">Project settings</StyledNavLink>
              </li>
              <li>
                <StyledNavLink to="/system">System parameters</StyledNavLink>
              </li>
              <li>
                <StyledNavLink to="/test">Test things</StyledNavLink>
              </li>
            </UL>
          </Sidebar>
        </Container>
      </Router>
    )
  }
}

export default App
